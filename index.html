<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‰©è²©ç®¡ç†è¡¨ å®‰å®šç‰ˆ</title>
<style>
body{font-family:sans-serif;background:#f4f6f9;margin:0;}
header{display:flex;justify-content:space-around;background:#1976d2;color:white;padding:12px;font-weight:bold;position:sticky;top:0;z-index:100;}
header button{background:none;border:none;color:white;font-size:13px;font-weight:bold;}
.page{display:none;padding:12px;}
.active{display:block;}
.box{background:white;padding:12px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.15);margin-bottom:15px;}
input,select,textarea,button{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:1px solid #ccc;font-size:14px;}
button{background:#1976d2;color:white;border:none;cursor:pointer;}
.deleteBtn{background:#dc3545;}
.editBtn{background:#28a745;}
.plus{color:green;font-weight:bold;}
.minus{color:red;font-weight:bold;}
table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px;}
th,td{border:1px solid #ccc;padding:4px;text-align:center;}
thead th{background:#1976d2;color:white;}
.monthHeader{background:#eee;font-weight:bold;cursor:pointer;}
.hidden{display:none;}
.progress select{width:60px;}
@media print{header,button{display:none;}body{background:white;}}
</style>
</head>
<body>

<header>
<button onclick="showPage('inputPage')">ğŸ“¥å…¥åŠ›</button>
<button onclick="showPage('listPage')">ğŸ“¦ç®¡ç†è¡¨</button>
<button onclick="showPage('dailyPage')">ğŸ“„æ—¥å ±</button>
<button onclick="showPage('monthlyPage')">ğŸ“„æœˆå ±</button>
</header>

<!-- å…¥åŠ›ãƒšãƒ¼ã‚¸ -->
<div id="inputPage" class="page active">
<h2>ğŸ“¥ ç‰©è²©å…¥åŠ›</h2>
<div class="box">
<input id="product" placeholder="å•†å“å">
<input id="cost" type="number" placeholder="ä»•å…¥">
<input id="sales" type="number" placeholder="å£²ä¸Šï¼ˆç©ºãªã‚‰å‡ºå“ä¸­ï¼‰">
<select id="category">
<option>ä¸ç”¨å“</option>
<option>æ ¼å®‰</option>
<option>Amazon</option>
<option>å›½éš›è¼¸å…¥</option>
<option>ã‚¢ãƒ‘ãƒ¬ãƒ«</option>
<option>ç„¡åœ¨åº«</option>
<option>ãƒ–ãƒ©ãƒ³ãƒ‰</option>
</select>
<select id="shippingSelect">
<option value="0">é€æ–™é¸æŠ</option>
<option value="160">ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆmini160</option>
<option value="215">ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆãƒã‚¹ãƒˆ215</option>
<option value="230">ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆ230</option>
<option value="455">ã‚†ã†ãƒ‘ã‚±ãƒƒãƒˆãƒ—ãƒ©ã‚¹455</option>
<option value="210">ãƒã‚³ãƒã‚¹210</option>
<option value="450">å®…æ€¥ä¾¿ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ450</option>
</select>
<input id="shippingManual" type="number" placeholder="é€æ–™ æ‰‹å…¥åŠ›">
<select id="platform">
<option>ãƒ¡ãƒ«ã‚«ãƒª</option>
<option>Yahooï¼ãƒ•ãƒªãƒ</option>
<option>ãƒ¤ãƒ•ã‚ªã‚¯</option>
<option>ã‚¸ãƒ¢ãƒ†ã‚£</option>
<option>ãƒ©ã‚¯ãƒ</option>
</select>
<input id="feeManualInput" type="number" placeholder="è²©å£²æ‰‹æ•°æ–™ æ‰‹å…¥åŠ›ï¼ˆä»»æ„ï¼‰">
å‡ºå“æ—¥:<input id="listDate" type="date">
å£²ä¸Šæ—¥:<input id="saleDate" type="date">
<button onclick="addItem()">ä¿å­˜</button>
</div>
</div>

<!-- ç®¡ç†è¡¨ãƒšãƒ¼ã‚¸ -->
<div id="listPage" class="page">
<h2>ğŸ“¦ ç®¡ç†è¡¨</h2>
<div class="box">
<table>
<thead>
<tr>
<th>çŠ¶æ…‹</th><th>å‡ºå“æ—¥</th><th>å£²ä¸Šæ—¥</th>
<th>å•†å“</th><th>ã‚«ãƒ†ã‚´ãƒª</th>
<th>ä»•å…¥</th><th>å£²ä¸Š</th>
<th>é€æ–™</th><th>æ‰‹æ•°æ–™</th>
<th>åˆ©ç›Š</th><th>åˆ©ç›Šç‡</th>
<th>ç·¨é›†</th><th>å‰Šé™¤</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div id="categorySummary"></div>
</div>
</div>

<!-- æ—¥å ±ãƒšãƒ¼ã‚¸ -->
<div id="dailyPage" class="page">
<div class="box">
<h2 id="dailyTitle"></h2>
<div id="dailyContent"></div>
</div>
</div>

<!-- æœˆå ±ãƒšãƒ¼ã‚¸ -->
<div id="monthlyPage" class="page">
<div class="box">
<h2 id="monthlyTitle"></h2>
<div id="monthlyContent"></div>
</div>
</div>

<script>
let data=JSON.parse(localStorage.getItem("buppan"))||[];
let dailyMemo=JSON.parse(localStorage.getItem("dailyMemo"))||{};
let monthlyMemo=JSON.parse(localStorage.getItem("monthlyMemo"))||{};
const today=new Date().toISOString().slice(0,10);
listDate.value=today;

function saveAll(){
localStorage.setItem("buppan",JSON.stringify(data));
localStorage.setItem("dailyMemo",JSON.stringify(dailyMemo));
localStorage.setItem("monthlyMemo",JSON.stringify(monthlyMemo));
}

function calcFee(item){
if(item.sales<=0)return 0;
if(item.feeManual>0)return item.feeManual;
if(item.platform==="Yahooï¼ãƒ•ãƒªãƒ")return Math.floor(item.sales*0.05);
if(item.platform==="ãƒ¡ãƒ«ã‚«ãƒª")return Math.floor(item.sales*0.10);
if(item.platform==="ãƒ¤ãƒ•ã‚ªã‚¯")return Math.floor(item.sales*0.10);
return 0;
}

function calcProfit(item){return item.sales-item.cost-item.shipping-calcFee(item);}
function showPage(id){
document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
document.getElementById(id).classList.add("active");
if(id==="listPage")render();
if(id==="dailyPage")generateDaily();
if(id==="monthlyPage")generateMonthly();
}

function addItem(){
let shipping=(+shippingManual.value>0)?+shippingManual.value:+shippingSelect.value;
let item={
product:product.value,
cost:+cost.value||0,
sales:+sales.value||0,
category:category.value,
shipping:shipping,
platform:platform.value,
feeManual:+feeManualInput.value||0,
listDate:listDate.value,
saleDate:saleDate.value
};
data.push(item);
saveAll();
location.reload();
}

function editItem(i){
let item=data[i];
product.value=item.product;
cost.value=item.cost;
sales.value=item.sales;
category.value=item.category;
shippingManual.value=item.shipping;
platform.value=item.platform;
feeManualInput.value=item.feeManual;
listDate.value=item.listDate;
saleDate.value=item.saleDate;
data.splice(i,1);
saveAll();
showPage("inputPage");
}

function render(){
tableBody.innerHTML="";
let grouped={};
data.forEach((item,i)=>{
if(item.saleDate){
let m=item.saleDate.slice(0,7);
if(!grouped[m])grouped[m]=[];
grouped[m].push({item,index:i});
}else{addRow(item,i);}
});
Object.keys(grouped).sort().reverse().forEach(month=>{
tableBody.innerHTML+=`<tr class="monthHeader" onclick="toggleMonth('${month}')"><td colspan="13">â–¶ ${month}</td></tr>`;
grouped[month].forEach(obj=>{addRow(obj.item,obj.index,month);});
});
generateCategorySummary();
}

function toggleMonth(month){document.querySelectorAll(`[data-month='${month}']`).forEach(r=>r.classList.toggle("hidden"));}
function addRow(item,i,month=null){
let sold=item.sales>0;
let fee=sold?calcFee(item):0;
let profit=sold?calcProfit(item):0;
let rate=sold?Math.floor(profit/item.sales*100):0;
tableBody.innerHTML+=`<tr ${month?`data-month="${month}" class="hidden"`:""}>
<td>${sold?"å£²ä¸Šæ¸ˆ":"å‡ºå“ä¸­"}</td>
<td>${item.listDate||""}</td>
<td>${item.saleDate||"-"}</td>
<td>${item.product}</td>
<td>${item.category}</td>
<td>Â¥${item.cost}</td>
<td>${sold?"Â¥"+item.sales:"-"}</td>
<td>Â¥${item.shipping}</td>
<td>${sold?"Â¥"+fee:"-"}</td>
<td class="${profit>=0?"plus":"minus"}">${sold?"Â¥"+profit:"-"}</td>
<td>${sold?rate+"%":"-"}</td>
<td><button class="editBtn" onclick="editItem(${i})">ç·¨é›†</button></td>
<td><button class="deleteBtn" onclick="data.splice(${i},1);saveAll();render();">å‰Šé™¤</button></td>
</tr>`;}

// æœˆåˆ¥ã‚«ãƒ†ã‚´ãƒªé›†è¨ˆ
function generateCategorySummary(){
let months=[...new Set(data.map(i=>i.saleDate?i.saleDate.slice(0,7):i.listDate?.slice(0,7)).filter(Boolean))].sort().reverse();
if(months.length===0){categorySummary.innerHTML="";return;}
categorySummary.innerHTML=`<select id="summaryMonth" onchange="updateSummary()">${months.map(m=>`<option>${m}</option>`).join("")}</select><div id="summaryTable"></div>`;
updateSummary();
}

function updateSummary(){
let month=document.getElementById("summaryMonth").value;
let summary={};
data.forEach(item=>{
let m=item.saleDate?item.saleDate.slice(0,7):item.listDate?.slice(0,7);
if(m===month){
if(!summary[item.category])summary[item.category]={sales:0,profit:0,sold:0,listed:0};
if(item.sales>0){summary[item.category].sales+=item.sales;summary[item.category].profit+=calcProfit(item);summary[item.category].sold++;}else{summary[item.category].listed++;}
}
});
let html=`<table><tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>å£²ä¸Š</th><th>åˆ©ç›Š</th><th>åˆ©ç›Šç‡</th><th>å£²ä¸Šä»¶æ•°</th><th>å‡ºå“ä¸­ä»¶æ•°</th></tr>`;
Object.keys(summary).forEach(cat=>{
let s=summary[cat];
let rate=s.sales?Math.floor(s.profit/s.sales*100):0;
html+=`<tr><td>${cat}</td><td>Â¥${s.sales}</td><td>Â¥${s.profit}</td><td>${rate}%</td><td>${s.sold}</td><td>${s.listed}</td></tr>`;
});
html+="</table>";
summaryTable.innerHTML=html;
}

// æ—¥å ±
function generateDaily(){
let month=today.slice(0,7);
let todayItems=data.filter(i=>i.listDate===today);
let todayProfit=data.filter(i=>i.saleDate===today).reduce((s,i)=>s+calcProfit(i),0);
let monthItems=data.filter(i=>i.listDate?.startsWith(month));
let monthProfit=data.filter(i=>i.saleDate?.startsWith(month)).reduce((s,i)=>s+calcProfit(i),0);
dailyTitle.textContent=today+" æ—¥å ±";
dailyContent.innerHTML=`
<h3>æœˆé–“ç›®æ¨™</h3><textarea onchange="dailyMemo.goal=this.value;saveAll()">${dailyMemo.goal||""}</textarea>
<h3>å‡ºå“ãƒ»åˆ©ç›ŠçŠ¶æ³</h3>
æœ¬æ—¥ã®å‡ºå“æ•°:${todayItems.length}ç‚¹ / åˆ©ç›Š:${todayProfit}å††<br>
ä»Šæœˆã®å‡ºå“æ•°:${monthItems.length}ç‚¹ / åˆ©ç›Š:${monthProfit}å††
<h3>é€²æ­©çŠ¶æ³</h3>
${["ä¸ç”¨å“","æ ¼å®‰","Amazon","ã‚¢ãƒ‘ãƒ¬ãƒ«","å›½éš›è¼¸å…¥","ç„¡åœ¨åº«","ãƒ–ãƒ©ãƒ³ãƒ‰"].map(cat=>`
${cat} <select onchange="dailyMemo['prog_${cat}']=this.value;saveAll()">
<option ${dailyMemo["prog_"+cat]==="ã€‡"?"selected":""}>ã€‡</option>
<option ${dailyMemo["prog_"+cat]==="â–³"?"selected":""}>â–³</option>
<option ${dailyMemo["prog_"+cat]==="Ã—"?"selected":""}>Ã—</option>
</select>
`).join("")}
<h3>æŒ¯ã‚Šè¿”ã‚Š</h3><textarea onchange="dailyMemo.reflection=this.value;saveAll()">${dailyMemo.reflection||""}</textarea>
<h3>æ„Ÿæƒ³ãƒ»ç›¸è«‡ãƒ»è³ªå•ãƒ»æ‚©ã¿</h3><textarea onchange="dailyMemo.thoughts=this.value;saveAll()">${dailyMemo.thoughts||""}</textarea>
<button onclick="window.print()">å°åˆ·</button>
`;
}

// æœˆå ±
function generateMonthly(){
let month=today.slice(0,7);
monthlyTitle.textContent=month+" æœˆå ±";
let monthData=data.filter(i=>i.saleDate?.startsWith(month));
let totalSales=monthData.reduce((s,i)=>s+i.sales,0);
let totalProfit=monthData.reduce((s,i)=>s+calcProfit(i),0);
let summary={};
monthData.forEach(i=>{
if(!summary[i.category])summary[i.category]={sales:0,profit:0,count:0};
summary[i.category].sales+=i.sales;
summary[i.category].profit+=calcProfit(i);
summary[i.category].count++;
});
let table="<table><tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>å£²ä¸Š</th><th>åˆ©ç›Š</th><th>åˆ©ç›Šç‡</th><th>å£²ä¸Šä»¶æ•°</th></tr>";
for(let c in summary){
let s=summary[c];
let rate=s.sales?Math.floor(s.profit/s.sales*100):0;
table+=`<tr><td>${c}</td><td>Â¥${s.sales}</td><td>Â¥${s.profit}</td><td>${rate}%</td><td>${s.count}</td></tr>`;
}
table+="</table>";
monthlyContent.innerHTML=`
<h3>æœˆé–“ç›®æ¨™</h3><textarea onchange="monthlyMemo.goal=this.value;saveAll()">${monthlyMemo.goal||""}</textarea>
<h3>ä»Šæœˆã®å£²ä¸Š</h3>${table}ç·å£²ä¸Š:Â¥${totalSales} / ç·åˆ©ç›Š:Â¥${totalProfit}
<h3>é€²æ­©çŠ¶æ³</h3>
${["ä¸ç”¨å“","æ ¼å®‰","Amazon","ã‚¢ãƒ‘ãƒ¬ãƒ«","å›½éš›è¼¸å…¥","ç„¡åœ¨åº«","ãƒ–ãƒ©ãƒ³ãƒ‰"].map(cat=>`
${cat} <select onchange="monthlyMemo['prog_${cat}']=this.value;saveAll()">
<option ${monthlyMemo["prog_"+cat]==="ã€‡"?"selected":""}>ã€‡</option>
<option ${monthlyMemo["prog_"+cat]==="â–³"?"selected":""}>â–³</option>
<option ${monthlyMemo["prog_"+cat]==="Ã—"?"selected":""}>Ã—</option>
</select>`).join("")}
<h3>æŒ¯ã‚Šè¿”ã‚Š</h3><textarea onchange="monthlyMemo.reflection=this.value;saveAll()">${monthlyMemo.reflection||""}</textarea>
<h3>æ„Ÿæƒ³ãƒ»ç›¸è«‡ãƒ»è³ªå•ãƒ»æ‚©ã¿</h3><textarea onchange="monthlyMemo.thoughts=this.value;saveAll()">${monthlyMemo.thoughts||""}</textarea>
<button onclick="window.print()">å°åˆ·</button>
`;
}

render();
</script>
</body>
</html>
